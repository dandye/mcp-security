# Malware Incident Response Plan (IRP) Runbook

## Objective

Provide a structured workflow for responding to suspected malware incidents, coordinating investigation, containment, eradication, and recovery efforts using available tools and procedures. This runbook orchestrates various specialized runbooks.

## Scope

This master runbook covers the end-to-end response lifecycle for malware incidents, from initial detection to post-incident review. It relies on specific sub-runbooks for detailed execution steps.

## Phases (PICERL Model)

1.  **Preparation:** *(Ongoing)* Ensure tools are operational, asset context is available, relevant detections are active, and communication channels are defined. Refer to `.clinerules/project_plan.md` for environment context goals.
2.  **Identification:** Detect the potential malware incident and perform initial triage and analysis.
3.  **Containment:** Limit the scope and magnitude of the incident.
4.  **Eradication:** Remove the malware and any associated persistence mechanisms.
5.  **Recovery:** Restore affected systems to normal operation.
6.  **Lessons Learned (Post-Incident):** Review the incident and response to identify improvements.

## Inputs

*   `${CASE_ID}`: The SOAR case ID created for or associated with the initial alert(s).
*   `${ALERT_GROUP_IDENTIFIERS}`: Relevant alert group identifiers from the SOAR case.
*   `${INITIAL_INDICATORS}`: Details from the initial alert(s) (e.g., Alert Name, Severity, Involved Entities like Hashes, IPs, Hosts, Users).

## Tools

*   All tools listed in the referenced sub-runbooks, primarily:
    *   `secops-soar`
    *   `secops-mcp`
    *   `gti-mcp`
    *   `scc-mcp` (if cloud resources involved)
    *   Potentially EDR/Identity tools if integrated.

## Workflow Steps & Diagram

```{mermaid}
sequenceDiagram
    participant Analyst
    participant IRP as malware_incident_response.md (This Runbook)
    participant Preparation as Phase 1: Preparation
    participant Identification as Phase 2: Identification
    participant Containment as Phase 3: Containment
    participant Eradication as Phase 4: Eradication
    participant Recovery as Phase 5: Recovery
    participant LessonsLearned as Phase 6: Lessons Learned

    Analyst->>IRP: Start Malware Response\nInput: CASE_ID, ALERT_GROUP_IDS, INITIAL_INDICATORS

    IRP->>Preparation: Verify Prerequisites (Ongoing)
    Preparation-->>IRP: Readiness Confirmed

    IRP->>Identification: Execute Identification Steps
    Identification-->>IRP: Initial Findings, IOCs, Affected Entities

    IRP->>Containment: Execute Containment Steps
    Containment-->>IRP: Containment Status

    IRP->>Eradication: Execute Eradication Steps
    Eradication-->>IRP: Eradication Status

    IRP->>Recovery: Execute Recovery Steps
    Recovery-->>IRP: Recovery Status

    IRP->>LessonsLearned: Execute Post-Incident Steps
    LessonsLearned-->>IRP: Review Complete

    IRP-->>Analyst: Incident Response Complete
```

---

### Phase 1: Preparation (Ongoing)

*   **Objective:** Ensure readiness to respond.
*   **Actions:**
    *   Periodically verify tool connectivity (e.g., using ping actions if available).
    *   Ensure asset inventory context is reasonably up-to-date (Refer to `.clinerules/project_plan.md`).
    *   Review and understand relevant detection rules (`secops-mcp.list_security_rules`).
    *   Ensure familiarity with communication and escalation plans (`.clinerules/escalation_paths.md`, `.clinerules/key_contacts.md`).

---

### Phase 2: Identification

*   **Objective:** Detect the incident, perform initial triage, identify malware, and understand initial scope.
*   **Sub-Runbooks/Steps:**
    1.  **Initial Triage:**
        *   Execute `.clinerules/run_books/triage_alerts.md` using `${CASE_ID}` or related alert IDs.
        *   Gather initial context (`secops-soar.get_case_full_details`).
        *   Check for duplicates (`common_steps/check_duplicate_cases.md`). If duplicate, close and stop.
    2.  **Malware Triage:**
        *   If a file hash is a primary indicator, execute `.clinerules/run_books/malware_triage.md` with `${FILE_HASH}`, `${CASE_ID}`, `${ALERT_GROUP_IDENTIFIERS}`.
        *   This involves GTI checks (`gti-mcp.get_file_report`, `gti-mcp.get_file_behavior_summary`) and SIEM checks (`secops-mcp.search_security_events`).
        *   Output: Malware classification, observed behaviors, affected hosts/users.
    3.  **IOC Enrichment (Initial):**
        *   For other key IOCs (IPs, Domains, URLs) identified in initial alerts or malware triage:
        *   Execute `.clinerules/run_books/common_steps/enrich_ioc.md` for each IOC.
    4.  **Initial Scope Assessment:**
        *   Based on triage and enrichment, identify the initial list of potentially affected hosts, users, and malicious IOCs.
        *   Document findings using `common_steps/document_in_soar.md`.

---

### Phase 3: Containment

*   **Objective:** Prevent the malware from spreading further and stop ongoing malicious activity.
*   **Sub-Runbooks/Steps:**
    1.  **Endpoint Isolation:**
        *   For each confirmed or highly suspected affected endpoint identified in Phase 2:
        *   Execute `.clinerules/run_books/basic_endpoint_triage_isolation.md`. **Confirm isolation action with analyst.**
    2.  **Network IOC Containment:**
        *   For each confirmed malicious network IOC (IP, Domain) identified:
        *   Execute `.clinerules/run_books/ioc_containment.md`. **Confirm containment action with analyst.**
    3.  **User Account Containment (If Applicable):**
        *   If investigation indicates a compromised user account was involved in malware execution/spread:
        *   Execute `.clinerules/run_books/compromised_user_account_response.md`. **Confirm containment actions with analyst.**
    4.  **Verify Containment:**
        *   Use `secops-mcp.search_security_events` to monitor for further activity related to contained IOCs or endpoints.
        *   Document containment status using `common_steps/document_in_soar.md`.

---

### Phase 4: Eradication

*   **Objective:** Remove malware artifacts and persistence mechanisms from affected systems.
*   **Sub-Runbooks/Steps:**
    1.  **Identify Persistence:**
        *   Analyze findings from Phase 2 (Malware Triage, GTI Behavior) and potentially deeper analysis (`deep_dive_ioc_analysis.md` if needed) to identify persistence mechanisms (e.g., scheduled tasks, services, registry keys).
    2.  **Remove Malware & Persistence:**
        *   *(Requires specific EDR/Endpoint Management tools or manual intervention)*
        *   Develop plan to remove identified malware files, registry keys, scheduled tasks, services etc. from contained endpoints.
        *   Execute removal actions.
    3.  **Scan for Residual Infection:**
        *   *(Requires EDR/AV tools)*
        *   Perform thorough scans on affected systems post-eradication attempts.
    4.  **Document Eradication:**
        *   Document actions taken and scan results using `common_steps/document_in_soar.md`.

---

### Phase 5: Recovery

*   **Objective:** Restore affected systems to normal operation safely.
*   **Sub-Runbooks/Steps:** *(Placeholder - Requires dedicated Recovery Runbook)*
    1.  **Determine Recovery Strategy:** Decide whether to rebuild systems from a known-good image/backup or clean existing systems (based on severity, admin rights involved, eradication confidence).
    2.  **Rebuild/Clean Systems:** Execute the chosen strategy. *(Likely involves IT Ops/System Admins)*.
    3.  **Patch & Harden:** Ensure recovered systems are fully patched and hardened before reconnecting. Perform vulnerability scans (`scc-mcp` or other tools).
    4.  **Restore Data (If Necessary):** Restore data from clean backups.
    5.  **Monitor Systems:** Closely monitor recovered systems for any signs of residual infection or abnormal behavior using SIEM/EDR.
    6.  **Lift Containment:** Gradually remove isolation measures once confidence in recovery is high.
    7.  **Document Recovery:** Document steps taken using `common_steps/document_in_soar.md`.

---

### Phase 6: Lessons Learned (Post-Incident)

*   **Objective:** Review the incident and response to identify areas for improvement.
*   **Sub-Runbooks/Steps:** *(Placeholder - Requires dedicated Post-Incident Runbook)*
    1.  **Incident Review Meeting:** Conduct a post-mortem meeting with involved parties.
    2.  **Analyze Response:** Review the timeline, actions taken, tool effectiveness, and runbook adherence. What worked well? What didn't?
    3.  **Identify Gaps:** Identify gaps in detection, prevention, response procedures, or tool capabilities.
    4.  **Develop Recommendations:** Formulate specific, actionable recommendations for improvement (e.g., new detection rules, runbook updates, configuration changes, user training).
    5.  **Update Documentation:** Update relevant runbooks, policies, and procedures.
    6.  **Track Recommendations:** Assign owners and track implementation of recommendations.
    7.  **Final Report:** Generate a final incident report using guidelines from `.clinerules/reporting_templates.md` and `.clinerules/run_books/guidelines/report_writing.md`.
    8.  **Document Review:** Document the review process and outcomes using `common_steps/document_in_soar.md` or a dedicated reporting mechanism.

---

### Phase 7: Lessons Learned / Runbook Feedback

*   **Objective:** Capture feedback on the runbook's effectiveness and identify areas for improvement based on this incident.
*   **Actions:**
    1.  **Runbook Effectiveness:**
        *   Did this runbook accurately guide the response?
        *   Were there any unclear or missing steps?
        *   Did the tools function as expected based on the runbook steps?
    2.  **Tool Performance:**
        *   Were there any issues with specific MCP tool calls (errors, unexpected results, rate limits)?
        *   Did the tool outputs provide the necessary information?
    3.  **Process Gaps:**
        *   Did the incident reveal gaps in detection, prevention, or other related processes?
    4.  **Suggestions for Improvement:**
        *   Specific recommendations for updating this runbook.
        *   Suggestions for new detection rules or tuning existing ones.
        *   Recommendations for tool configuration changes or new tool requirements.
    5.  **Documentation:** Record this feedback within the SOAR case (`${CASE_ID}`) using `common_steps/document_in_soar.md` or a dedicated lessons learned repository.
