# Malware Triage Runbook

## Objective

Perform initial analysis and context gathering for a suspected malicious file hash identified during an investigation or alert triage. This helps determine the nature of the file and its potential impact.

## Scope

This runbook covers the initial triage steps for a file hash using GTI and SIEM tools. It does not include full reverse engineering or deep forensic analysis of the affected host.

## Inputs

*   `${FILE_HASH}`: The MD5, SHA1, or SHA256 hash of the suspected malicious file.
*   `${CASE_ID}`: The relevant SOAR case ID for documentation.
*   `${ALERT_GROUP_IDENTIFIERS}`: Relevant alert group identifiers from the SOAR case.
*   *(Optional) `${TIME_FRAME_HOURS}`: Lookback period in hours for SIEM searches (default: 72).*

## Tools

*   `gti-mcp`: `get_file_report`, `get_file_behavior_summary`, `get_entities_related_to_a_file` (for contacted IPs/domains), `get_ip_address_report`, `get_domain_report`.
*   `secops-mcp`: `search_security_events`, `lookup_entity`.
*   `secops-soar`: `post_case_comment`, `get_case_full_details`.
*   **Basic Endpoint Triage & Isolation Runbook:** `.clinerules/run_books/basic_endpoint_triage_isolation.md` (Potentially triggered).

## Workflow Steps & Diagram

1.  **Receive Input & Context:** Obtain `${FILE_HASH}`, `${CASE_ID}`, `${ALERT_GROUP_IDENTIFIERS}`, and optionally `${TIME_FRAME_HOURS}`. Get case details via `secops-soar.get_case_full_details`.
2.  **GTI File Report:**
    *   Use `gti-mcp.get_file_report` with `hash=${FILE_HASH}`.
    *   Record key details: detection ratio, malware family classification, first/last seen, associated threats.
3.  **GTI Behavior Summary:**
    *   Use `gti-mcp.get_file_behavior_summary` with `hash=${FILE_HASH}`.
    *   Record key behavioral indicators: network connections (contacted IPs/domains), dropped files, registry keys modified, MITRE TTPs observed in sandbox.
4.  **SIEM Execution Check:**
    *   Use `secops-mcp.search_security_events` with `hours_back=${TIME_FRAME_HOURS}` and queries like:
        *   `target.file.sha256 = "${FILE_HASH}" OR target.file.md5 = "${FILE_HASH}" OR target.file.sha1 = "${FILE_HASH}"`
        *   Look for `PROCESS_LAUNCH`, `FILE_CREATION`, `FILE_MODIFICATION` events.
    *   Identify hosts (`principal.hostname`, `principal.ip`) and users (`principal.user.userid`) associated with these events.
5.  **SIEM Network Activity Check:**
    *   Use `secops-mcp.search_security_events` to check for network connections (`NETWORK_CONNECTION`, `NETWORK_DNS`) originating from processes associated with `${FILE_HASH}` (using `principal.process.file.sha256 = "${FILE_HASH}"` or similar).
    *   Correlate observed network activity with contacted IPs/domains from GTI behavior summary (Step 3).
6.  **Enrich Network IOCs:**
    *   For key contacted IPs/Domains identified in GTI (Step 3) or SIEM (Step 5):
        *   Use `gti-mcp.get_ip_address_report` / `get_domain_report`.
        *   Use `secops-mcp.lookup_entity`.
    *   Record reputation and local activity for related network IOCs.
7.  **Identify Affected Hosts:**
    *   Compile a list of unique hosts identified in Step 4 where the file was observed.
8.  **Synthesize & Document:**
    *   Combine findings: GTI report/behavior, SIEM execution/network activity, network IOC enrichment, list of affected hosts.
    *   Assess the severity based on GTI classification, behavior, and observed activity in the environment.
    *   Use `secops-soar.post_case_comment` for `${CASE_ID}`. Summarize: "Malware Triage for Hash `${FILE_HASH}`: GTI Class: [...], Behavior Summary: [...]. Observed on Hosts: [...]. Network Activity: [...]. Assessment: [...]."
9.  **Recommend Next Steps:**
    *   Based on the assessment, add recommendations: "[Trigger Endpoint Triage/Isolation for affected hosts] | [Block related Network IOCs (Trigger IOC Containment)] | [Escalate to Tier 3/IR for deeper analysis] | [Monitor]".
10. **Completion:** Conclude the runbook execution.

```{mermaid}
sequenceDiagram
    participant Analyst
    participant Cline as Cline (MCP Client)
    participant GTI as gti-mcp
    participant SIEM as secops-mcp
    participant SOAR as secops-soar
    participant Endpoint_Triage as Endpoint Triage Runbook

    Analyst->>Cline: Start Malware Triage\nInput: FILE_HASH, CASE_ID, ALERT_GROUP_IDS, TIME_FRAME_HOURS (opt)

    %% Step 1: Context
    Cline->>SOAR: get_case_full_details(case_id=CASE_ID)
    SOAR-->>Cline: Case Details

    %% Step 2: GTI File Report
    Cline->>GTI: get_file_report(hash=FILE_HASH)
    GTI-->>Cline: Detailed File Report
    Note over Cline: Record GTI classification, threats

    %% Step 3: GTI Behavior Summary
    Cline->>GTI: get_file_behavior_summary(hash=FILE_HASH)
    GTI-->>Cline: Behavior Summary (Network IOCs N1, N2...)
    Note over Cline: Record key behaviors, Network IOCs

    %% Step 4: SIEM Execution Check
    Cline->>SIEM: search_security_events(text="Events for hash FILE_HASH", hours_back=TIME_FRAME_HOURS)
    SIEM-->>Cline: Execution Events (Hosts H1, H2..., Users U1...)
    Note over Cline: Identify Affected Hosts/Users

    %% Step 5: SIEM Network Activity Check
    Cline->>SIEM: search_security_events(text="Network activity from process hash FILE_HASH", hours_back=TIME_FRAME_HOURS)
    SIEM-->>Cline: Network Events (Contacted IPs/Domains N3, N4...)
    Note over Cline: Correlate with GTI network IOCs

    %% Step 6: Enrich Network IOCs
    loop For each key Network IOC Ni (N1, N2, N3, N4...)
        Cline->>GTI: get_ip_address_report / get_domain_report (ioc=Ni)
        GTI-->>Cline: GTI Report for Ni
        Cline->>SIEM: lookup_entity(entity_value=Ni)
        SIEM-->>Cline: SIEM Summary for Ni
    end

    %% Step 7: Identify Affected Hosts
    Note over Cline: Compile unique list of Affected Hosts (H1, H2...)

    %% Step 8 & 9: Synthesize, Document & Recommend
    Note over Cline: Synthesize findings, assess severity
    Cline->>SOAR: post_case_comment(case_id=CASE_ID, comment="Malware Triage Summary for FILE_HASH... Affected Hosts: [...]. Assessment: [...]. Recommendation: [Isolate Hosts/Block IOCs/Escalate/Monitor]")
    SOAR-->>Cline: Comment Confirmation

    %% Step 10: Completion
    Cline->>Analyst: attempt_completion(result="Malware Triage complete for FILE_HASH. Findings and recommendation documented in case CASE_ID.")
