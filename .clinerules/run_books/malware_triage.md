# Malware Triage Runbook

## Objective

Perform initial analysis and context gathering for a suspected malicious file hash identified during an investigation or alert triage. This helps determine the nature of the file and its potential impact.

## Scope

This runbook covers the initial triage steps for a file hash using GTI and SIEM tools. It does not include full reverse engineering or deep forensic analysis of the affected host.

## Inputs

*   `${FILE_HASH}`: The MD5, SHA1, or SHA256 hash of the suspected malicious file.
*   `${CASE_ID}`: The relevant SOAR case ID for documentation.
*   `${ALERT_GROUP_IDENTIFIERS}`: Relevant alert group identifiers from the SOAR case.
*   *(Optional) `${TIME_FRAME_HOURS}`: Lookback period in hours for SIEM searches (default: 72).*

## Tools

*   `gti-mcp`: `get_file_report`, `get_file_behavior_summary`, `get_entities_related_to_a_file` (for contacted IPs/domains), `get_ip_address_report`, `get_domain_report`.
*   `secops-mcp`: `search_security_events`, `lookup_entity`.
*   `secops-soar`: `post_case_comment`, `get_case_full_details`.
*   **Basic Endpoint Triage & Isolation Runbook:** `.clinerules/run_books/basic_endpoint_triage_isolation.md` (Potentially triggered).

## Workflow Steps & Diagram

1.  **Receive Input & Context:** Obtain `${FILE_HASH}`, `${CASE_ID}`, `${ALERT_GROUP_IDENTIFIERS}`, and optionally `${TIME_FRAME_HOURS}`. Get case details via `secops-soar.get_case_full_details`.
2.  **GTI File Report:**
    *   Use `gti-mcp.get_file_report` with `hash=${FILE_HASH}`.
    *   Record key details (`${GTI_REPORT_DETAILS}`): detection ratio, malware family classification, first/last seen, associated threats.
3.  **GTI Behavior Summary:**
    *   Use `gti-mcp.get_file_behavior_summary` with `hash=${FILE_HASH}`.
    *   Record key behavioral indicators (`${GTI_BEHAVIOR_SUMMARY}`): network connections (contacted IPs/domains - `NETWORK_IOCs_GTI`), dropped files, registry keys modified, MITRE TTPs observed in sandbox.
4.  **SIEM Execution Check:**
    *   Use `secops-mcp.search_security_events` with `hours_back=${TIME_FRAME_HOURS}` and queries like:
        *   `target.file.sha256 = "${FILE_HASH}" OR target.file.md5 = "${FILE_HASH}" OR target.file.sha1 = "${FILE_HASH}"`
        *   Look for `PROCESS_LAUNCH`, `FILE_CREATION`, `FILE_MODIFICATION` events (`${SIEM_EXECUTION_EVENTS}`).
    *   Identify hosts (`AFFECTED_HOSTS`) and users (`AFFECTED_USERS`) associated with these events.
5.  **SIEM Network Activity Check:**
    *   Use `secops-mcp.search_security_events` to check for network connections (`NETWORK_CONNECTION`, `NETWORK_DNS`) originating from processes associated with `${FILE_HASH}` (using `principal.process.file.sha256 = "${FILE_HASH}"` or similar). Let these be `${SIEM_NETWORK_EVENTS}`.
    *   Extract contacted IPs/domains (`NETWORK_IOCs_SIEM`) from these events.
6.  **Enrich Network IOCs:**
    *   Combine unique IOCs from `NETWORK_IOCs_GTI` and `NETWORK_IOCs_SIEM` into `ALL_NETWORK_IOCs`.
    *   Initialize `NETWORK_IOC_ENRICHMENT`. For each IOC `Ni` in `ALL_NETWORK_IOCs`:
        *   Execute `common_steps/enrich_ioc.md` with `IOC_VALUE=Ni` and appropriate `IOC_TYPE`.
        *   Store results in `NETWORK_IOC_ENRICHMENT[Ni]`.
7.  **Synthesize & Document:**
    *   Combine findings: `${GTI_REPORT_DETAILS}`, `${GTI_BEHAVIOR_SUMMARY}`, `${SIEM_EXECUTION_EVENTS}`, `${SIEM_NETWORK_EVENTS}`, `NETWORK_IOC_ENRICHMENT`, `AFFECTED_HOSTS`.
    *   Assess the severity based on GTI classification, behavior, and observed activity.
    *   Prepare `COMMENT_TEXT`: "Malware Triage for Hash `${FILE_HASH}`: GTI Class: [...], Behavior Summary: [...]. Observed on Hosts: [`${AFFECTED_HOSTS}`]. Network Activity: [...]. Network IOC Enrichment: [...]. Assessment: [...]. Recommendation: [Trigger Endpoint Triage/Isolation for affected hosts] | [Block related Network IOCs (Trigger IOC Containment)] | [Escalate to Tier 3/IR for deeper analysis] | [Monitor]".
    *   Execute `common_steps/document_in_soar.md` with `${CASE_ID}` and `${COMMENT_TEXT}`. Obtain `${COMMENT_POST_STATUS}`.
8.  **Completion:** Conclude the runbook execution.

```{mermaid}
sequenceDiagram
    participant Analyst
    participant Cline as Cline (MCP Client)
    participant GTI as gti-mcp
    participant SIEM as secops-mcp
    participant SOAR as secops-soar
    participant EnrichIOC as common_steps/enrich_ioc.md
    participant DocumentInSOAR as common_steps/document_in_soar.md
    participant Endpoint_Triage as Endpoint Triage Runbook %% Still potentially triggered

    Analyst->>Cline: Start Malware Triage\nInput: FILE_HASH, CASE_ID, ALERT_GROUP_IDS, TIME_FRAME_HOURS (opt)

    %% Step 1: Context
    Cline->>SOAR: get_case_full_details(case_id=CASE_ID)
    SOAR-->>Cline: Case Details

    %% Step 2: GTI File Report
    Cline->>GTI: get_file_report(hash=FILE_HASH)
    GTI-->>Cline: Detailed File Report (GTI_REPORT_DETAILS)

    %% Step 3: GTI Behavior Summary
    Cline->>GTI: get_file_behavior_summary(hash=FILE_HASH)
    GTI-->>Cline: Behavior Summary (NETWORK_IOCs_GTI)

    %% Step 4: SIEM Execution Check
    Cline->>SIEM: search_security_events(text="Events for hash FILE_HASH", hours_back=TIME_FRAME_HOURS)
    SIEM-->>Cline: Execution Events (SIEM_EXECUTION_EVENTS, AFFECTED_HOSTS, AFFECTED_USERS)

    %% Step 5: SIEM Network Activity Check
    Cline->>SIEM: search_security_events(text="Network activity from process hash FILE_HASH", hours_back=TIME_FRAME_HOURS)
    SIEM-->>Cline: Network Events (SIEM_NETWORK_EVENTS, NETWORK_IOCs_SIEM)

    %% Step 6: Enrich Network IOCs
    Note over Cline: Combine NETWORK_IOCs_GTI and NETWORK_IOCs_SIEM into ALL_NETWORK_IOCs
    loop For each key Network IOC Ni in ALL_NETWORK_IOCs
        Cline->>EnrichIOC: Execute(Input: IOC_VALUE=Ni, IOC_TYPE=...)
        EnrichIOC-->>Cline: Results: Store in NETWORK_IOC_ENRICHMENT[Ni]
    end

    %% Step 7: Synthesize, Document & Recommend
    Note over Cline: Synthesize findings, assess severity, prepare COMMENT_TEXT with Recommendation
    Cline->>DocumentInSOAR: Execute(Input: CASE_ID, COMMENT_TEXT)
    DocumentInSOAR-->>Cline: Results: COMMENT_POST_STATUS

    %% Step 8: Completion
    Cline->>Analyst: attempt_completion(result="Malware Triage complete for FILE_HASH. Findings and recommendation documented in case CASE_ID.")
